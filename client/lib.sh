#!/bin/bash
# shellcheck disable=SC2034
###############################################################################################################
# CMD LINE OUTPUT                                                                                             #
###############################################################################################################
Color_Off='\e[0m'       # Text Reset
IRed='\e[0;91m'         # Red
IGreen='\e[0;92m'       # Green
IYellow='\e[0;93m'      # Yellow
IBlue='\e[0;94m'        # Blue

print_text_in_color() {
	/usr/bin/printf "%b%s%b\n" "$1" "$2" "$Color_Off"
}
success() {
	/bin/echo -e "${IGreen} $* ${Color_Off}" >&2
}
warning() {
	/bin/echo -e "${IYellow} $* ${Color_Off}" >&2
 	/bin/echo -e "${IYellow} $* ${Color_Off}" >> /var/log/WZC_INSTALL_ERROR.log 
	COUNTER=$((COUNTER+1))       
}
error() {
	/bin/echo -e "${IRed} $* ${Color_Off}" >&2
 	/bin/echo -e "${IYellow} $* ${Color_Off}" >> /var/log/WZC_INSTALL_ERROR.log 
	COUNTER=$((COUNTER+1))
}
header() {
	/bin/echo -e "${IBlue} $* ${Color_Off}" >&2
}
fatal() {
	/bin/echo -e "${IRed} $* ${Color_Off}" >&2
 	/bin/echo -e "${IYellow} $* ${Color_Off}" >> /var/log/WZC_INSTALL_ERROR.log   
	exit 1
}

###############################################################################################################
# FOLDERS                                                                                                     #
###############################################################################################################
CONFIG="/boot/config.txt"
GITDIR="/var/opt/server-client"
DJANGO="/home/dietpi/pidjango"
HOME="/home/dietpi"

###############################################################################################################
# SYSTEM                                                                                                      #
###############################################################################################################
USER='dietpi'
VERSION='0.0.7'

###############################################################################################################
# NETWORK                                                                                                     #
###############################################################################################################
WANIP4=$(curl -s -k -m 5 https://ipv4bot.whatismyipaddress.com)
GATEWAY=$(ip route | grep default | awk '{print $3}')
IFACE=$(ip r | grep "default via" | awk '{print $5}')
ADDRESS=$(hostname -I | cut -d ' ' -f 1)
NETMASK=$(ifconfig "$IFACE" | grep netmask | awk '{print $4}')
DOMAIN="waaromzomoeilijk.nl"

###############################################################################################################
# LINKS                                                                                                       #
###############################################################################################################
ISSUES="https://github.com/WaaromZoMoeilijk/server-client/issues"
REPO="https://github.com/WaaromZoMoeilijk/server-client" 

###############################################################################################################
# MISC                                                                                                        #
###############################################################################################################
REBOOT="sleep 40 && reboot"

###############################################################################################################
# FUNCTIONS                                                                                                   #
###############################################################################################################
is_root() {
    if [[ "$EUID" -ne 0 ]]; then
        return 1
    else
        return 0
    fi
}
root_check() {
    if ! is_root; then
        fatal "Failed, script needs sudo permission"
    fi
}
###############################################################################################################
# DEBUG                                                                                                       #
###############################################################################################################
debug_mode() {
    if [ "$DEBUG" -eq 1 ]; then
        set -ex
    fi
}
###############################################################################################################
# INSTALL                                                                                                     #
###############################################################################################################
apt_install() {
    apt install -y
}
###############################################################################################################
# UPDATE                                                                                                      #
###############################################################################################################
apt_update() {
    apt update
}
###############################################################################################################
# FULL-UPGRADE                                                                                                     #
###############################################################################################################
apt_upgrade() {
    sudo -E apt -o "Dpkg::Options::=--force-confdef" -o "Dpkg::Options::=--force-confold" full-upgrade -y 
}
###############################################################################################################
# AUTO-REMOVE                                                                                                 #
###############################################################################################################
apt_autoremove() {
    apt autoremove -y
}
###############################################################################################################
# AUTO-CLEAN                                                                                                  #
###############################################################################################################
apt_autoclean() {
    apt -y autoclean
}
###############################################################################################################
# SPINNER                                                                                                     #
###############################################################################################################
spinner() {
    printf '['
    while ps "$!" > /dev/null; do
        echo -n '⣾⣽⣻'
        sleep '.7'
    done
    echo ']'
}
###############################################################################################################
# CALC WHIPTAIL SIZE                                                                                          #
###############################################################################################################
calc_wt_size() {
    WT_HEIGHT=17
    WT_WIDTH=$(tput cols)

    if [ -z "$WT_WIDTH" ] || [ "$WT_WIDTH" -lt 60 ]; then
        WT_WIDTH=80
    fi
    if [ "$WT_WIDTH" -gt 178 ]; then
        WT_WIDTH=120
    fi
    WT_MENU_HEIGHT=$((WT_HEIGHT-7))
    export WT_MENU_HEIGHT
}
###############################################################################################################
# INSTALL IF NOT INSTALLED                                                                                    #
###############################################################################################################
install_if_not() {
    if ! dpkg-query -W -f='${Status}' "${1}" | grep -q "ok installed"; then
        apt update -q4 & spinner_loading && RUNLEVEL=1 apt install "${1}" -y
    fi
}
###############################################################################################################
# CHECK IF PROGRAM IS INSTALLED                                                                               #
###############################################################################################################
is_this_installed() {
    if dpkg-query -W -f='${Status}' "${1}" | grep -q "ok installed"; then
        return 0
    else
        return 1
    fi
}
###############################################################################################################
# STOP IF INSTALLED                                                                                           #
###############################################################################################################
stop_if_installed() {
    if [ "$(dpkg-query -W -f='${Status}' "${1}" 2>/dev/null | grep -c "ok installed")" == "1" ]; then
        print_text_in_color "$IRed" "${1} is installed, stopping."
        exit 1
    fi
}